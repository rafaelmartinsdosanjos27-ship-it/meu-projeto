<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dark Angel v55 - UI Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');
        
        :root { --red: #ff0000; --bg: #050505; }
        body { 
            background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; 
            height: 100dvh; margin: 0; overflow: hidden; position: fixed; width: 100%;
        }
        
        .app-container { display: flex; height: 100%; width: 100%; }
        
        #sidebar { 
            position: fixed; left: -280px; top: 0; bottom: 0; width: 280px; 
            background: #080808; border-right: 1px solid #1a1a1a; 
            display: flex; flex-direction: column; z-index: 1000; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #sidebar.open { transform: translateX(280px); }

        #notification-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            background: #111; border: 1px solid #222; border-left: 4px solid var(--red);
            color: white; padding: 12px 20px; border-radius: 12px; font-size: 11px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .chat-item { 
            padding: 12px 15px; margin: 4px 10px; border-radius: 12px; font-size: 11px; 
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
            display: flex; align-items: center; justify-content: space-between;
        }
        .chat-item.active { background: #1a0000; border-color: #ff000033; color: var(--red); font-weight: 900; }
        .chat-item.locked { opacity: 0.3; filter: grayscale(1); }

        main { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: #000; border-bottom: 1px solid #111; }
        
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; background: radial-gradient(circle at top, #0d0000 0%, #050505 100%); }
        
        .bubble { max-width: 85%; padding: 12px 16px; border-radius: 16px; font-size: 13px; line-height: 1.5; }
        .bubble-ai { align-self: flex-start; background: #0d0d0d; border: 1px solid #1a1a1a; border-left: 3px solid var(--red); }
        .bubble-user { align-self: flex-end; background: #1a1a1a; border: 1px solid #333; }

        .plan-badge { font-size: 8px; font-weight: 900; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .badge-free { background: #222; color: #888; }
        .badge-basico { background: #004400; color: #0f0; border: 1px solid #0f0; }
        .badge-avancado { background: #440000; color: #f00; border: 1px solid #f00; }

        footer { padding: 10px; background: #000; }
        .input-box { background: #0a0a0a; border: 1px solid #222; border-radius: 20px; display: flex; align-items: center; padding: 5px; }
        
        /* Modal Style with Close Button */
        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.92); 
            backdrop-filter: blur(5px); z-index: 2000; 
            display: flex; align-items: center; justify-content: center; padding: 20px; 
        }
        .modal-content {
            background: #0a0a0a; border: 1px solid #1a1a1a; 
            width: 100%; max-width: 350px; border-radius: 28px; 
            padding: 30px; position: relative;
        }
        .close-modal {
            position: absolute; top: 20px; right: 20px; width: 35px; h-35px;
            background: #1a1a1a; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; color: #555;
            cursor: pointer; transition: 0.3s;
        }
        .close-modal:hover { background: #ff0000; color: white; }
    </style>
</head>
<body>

    <div id="notification-container"></div>

    <!-- AUTH GATE (No close button here for security) -->
    <div id="auth-gate" class="modal">
        <div class="modal-content text-center">
            <h1 class="text-3xl font-black italic text-white mb-2">DARK<span class="text-red-600">ANGEL</span></h1>
            <p class="text-[8px] text-zinc-600 font-bold tracking-[0.4em] mb-8 uppercase">Operational UI v55</p>
            <button onclick="loginGoogle()" class="w-full bg-white text-black p-4 rounded-2xl font-black text-xs mb-4">GOOGLE LOGIN</button>
            <input type="email" id="email" class="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-xl mb-2 text-white text-sm" placeholder="Email">
            <input type="password" id="pass" class="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-xl mb-6 text-white text-sm" placeholder="Senha">
            <button onclick="loginEmail()" class="w-full bg-red-600 p-4 rounded-xl font-black text-xs uppercase">Entrar</button>
        </div>
    </div>

    <!-- APP -->
    <div id="app" class="app-container hidden">
        <aside id="sidebar">
            <div class="p-6">
                <button id="btn-new" onclick="newConversation()" class="w-full bg-zinc-900 p-4 rounded-xl font-black text-[10px] uppercase border border-zinc-800 mb-6 hover:bg-red-600">Novo Protocolo</button>
                <div class="bg-black/50 p-4 rounded-xl border border-zinc-900">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[8px] font-black uppercase text-zinc-600">Licen√ßa</span>
                        <div id="plan-display"></div>
                    </div>
                    <div class="flex justify-between text-[10px] mb-1">
                        <span class="text-zinc-400">Mensagens</span>
                        <span id="msg-count" class="text-white font-black">0/0</span>
                    </div>
                    <div class="w-full bg-zinc-900 h-1 rounded-full overflow-hidden">
                        <div id="msg-progress" class="bg-red-600 h-full w-0 transition-all duration-500"></div>
                    </div>
                </div>
            </div>
            <div id="chat-list" class="flex-1 overflow-y-auto"></div>
            <div class="p-4 border-t border-zinc-900">
                <button onclick="openStore()" class="w-full bg-red-600/10 border border-red-600/30 p-3 rounded-lg text-red-500 text-[10px] font-black uppercase mb-2">Comprar Cr√©ditos</button>
                <button id="btn-verify" onclick="verifyPayment()" class="w-full text-[8px] text-zinc-600 font-bold uppercase py-2">Sincronizar Pagamento</button>
            </div>
        </aside>

        <main>
            <header>
                <button onclick="toggleMenu()" class="text-white bg-zinc-900 w-10 h-10 rounded-lg border border-zinc-800"><i class="fa-solid fa-bars"></i></button>
                <span id="active-title" class="text-[10px] font-black uppercase text-zinc-500 truncate max-w-[150px]">Terminal</span>
                <div class="flex gap-4 items-center">
                    <button onclick="openKeyModal()" class="text-zinc-600 text-xs"><i class="fa-solid fa-key"></i></button>
                    <button onclick="logout()" class="text-zinc-600"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </header>

            <div id="chat-window"></div>

            <footer>
                <div id="lock-notice" class="hidden text-[9px] text-center mb-2 text-red-500 font-black uppercase tracking-widest animate-pulse">
                    Limite Excedido. Reset em: <span id="reset-timer">00:00:00</span>
                </div>
                <div id="input-area" class="input-box">
                    <input id="prompt" class="flex-1 bg-transparent p-4 text-sm text-white outline-none" placeholder="Comando..." onkeydown="if(event.key==='Enter') send()">
                    <button onclick="send()" class="bg-red-600 w-10 h-10 rounded-xl flex items-center justify-center m-1 shadow-lg shadow-red-900/40">
                        <i class="fa-solid fa-bolt text-xs"></i>
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <!-- STORE MODAL -->
    <div id="store-modal" class="modal hidden" onclick="if(event.target === this) closeStore()">
        <div class="modal-content text-center">
            <div class="close-modal" onclick="closeStore()"><i class="fa-solid fa-xmark"></i></div>
            <h2 class="text-white font-black text-xl mb-6 italic">LOJA <span class="text-red-600">VIP</span></h2>
            <div class="space-y-3 mb-4">
                <div class="bg-zinc-900 p-4 rounded-2xl border border-zinc-800 text-left">
                    <div class="flex justify-between font-black text-[10px] mb-1"><span class="text-green-500">B√ÅSICO</span> <span class="text-white">R$ 10</span></div>
                    <a href="https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=a506437035154280b71299946639bb46" target="_blank" onclick="logAction('B√°sico')" class="block w-full bg-white text-black py-3 rounded-lg font-black text-center text-[10px] mt-4 uppercase">Assinar PIX</a>
                </div>
                <div class="bg-red-900/10 p-4 rounded-2xl border border-red-600/20 text-left">
                    <div class="flex justify-between font-black text-[10px] mb-1"><span class="text-red-600">AVAN√áADO</span> <span class="text-white">R$ 35</span></div>
                    <a href="https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=115c3f71f00c467fb6b957e21cd44aa0" target="_blank" onclick="logAction('Avan√ßado')" class="block w-full bg-red-600 text-white py-3 rounded-lg font-black text-center text-[10px] mt-4 uppercase">Assinar PIX</a>
                </div>
            </div>
        </div>
    </div>

    <!-- API KEY MODAL -->
    <div id="key-modal" class="modal hidden" onclick="if(event.target === this) closeKeyModal()">
        <div class="modal-content text-center">
            <div class="close-modal" onclick="closeKeyModal()"><i class="fa-solid fa-xmark"></i></div>
            <h2 class="text-white font-black text-xs mb-6 uppercase tracking-widest">Configurar Chave Gemini</h2>
            <input type="password" id="api-input" class="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-xl mb-4 text-white text-xs text-center" placeholder="Cole sua API Key aqui">
            <button onclick="saveKey()" class="w-full bg-red-600 p-4 rounded-xl font-black text-[10px] uppercase">Salvar Configura√ß√£o</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAPVM-uc_yHKcY7an0pQABzS2UgRsbNY8",
            authDomain: "hjjj-f7cf5.firebaseapp.com",
            projectId: "hjjj-f7cf5",
            storageBucket: "hjjj-f7cf5.firebasestorage.app",
            messagingSenderId: "162911169867",
            appId: "1:162911169867:web:4a8e8d2db6fd886c390cce"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1467217014157213759/h8mtZp6daIb7gNwzKdHZyGaoeHj6qnJxDLOrsTM6TdZYQWjMJ_H-0Z3sPHMAXjt09rL8";

        let userData = { plan: 'free', used: 0, lastReset: Date.now() };
        let sessions = JSON.parse(localStorage.getItem('da_v55_sessions')) || [];
        let currentId = null;
        let geminiKey = localStorage.getItem('da_gemini_v55') || "";

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('auth-gate').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        if(userData.plan === 'free' && data.plan !== 'free') showToast("Upgrade Ativado com Sucesso!");
                        userData = data;
                        if(data.apiKey) { geminiKey = data.apiKey; localStorage.setItem('da_gemini_v55', geminiKey); }
                    } else {
                        setDoc(doc(db, "users", user.uid), { plan: 'free', used: 0, lastReset: Date.now(), email: user.email });
                    }
                    updateUI();
                });
                if(sessions.length > 0) loadSession(sessions[0].id); else newConversation();
            } else {
                document.getElementById('auth-gate').classList.remove('hidden');
            }
        });

        function showToast(msg) {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3000);
        }

        async function notifyDiscord(title, desc, color = 15548997) {
            const user = auth.currentUser;
            if(!user) return;
            await fetch(DISCORD_WEBHOOK, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ embeds: [{ title, description: desc, color, fields: [{ name: "üë§ Email", value: user.email }, { name: "üÜî UID", value: `\`${user.uid}\`` }], timestamp: new Date().toISOString() }] })
            });
        }

        window.logAction = (p) => { showToast("A processar..."); notifyDiscord("üõí PAGAMENTO", `Utilizador clicou no plano: ${p}`, 5763719); };
        
        window.verifyPayment = () => {
            const btn = document.getElementById('btn-verify');
            btn.innerText = "Sincronizando..."; btn.disabled = true;
            showToast("Aviso enviado para o Discord!");
            notifyDiscord("üîç VERIFICA√á√ÉO", "O utilizador solicitou liberta√ß√£o manual.", 16776960);
            setTimeout(() => { btn.innerText = "Sincronizar Pagamento"; btn.disabled = false; }, 10000);
        };

        function updateUI() {
            const plan = userData.plan || 'free';
            const used = userData.used || 0;
            const lastReset = userData.lastReset || Date.now();
            let max = 30; let hours = 5;
            if(plan === 'basico') { max = 75; hours = 10; }
            if(plan === 'avancado') { max = 120; hours = 15; }

            document.getElementById('plan-display').innerHTML = `<span class="plan-badge badge-${plan}">${plan}</span>`;
            document.getElementById('msg-count').innerText = `${used}/${max}`;
            document.getElementById('msg-progress').style.width = (used/max*100) + '%';

            const now = Date.now();
            const cooldown = hours * 3600000;
            const remaining = cooldown - (now - lastReset);

            if(remaining <= 0) {
                if(used > 0) updateDoc(doc(db, "users", auth.currentUser.uid), { used: 0, lastReset: now });
                document.getElementById('input-area').style.opacity = "1";
                document.getElementById('input-area').style.pointerEvents = "auto";
                document.getElementById('lock-notice').classList.add('hidden');
            } else if (used >= max) {
                document.getElementById('input-area').style.opacity = "0.2";
                document.getElementById('input-area').style.pointerEvents = "none";
                document.getElementById('lock-notice').classList.remove('hidden');
                startTimer(remaining);
            }
            refreshList();
        }

        function startTimer(ms) {
            const el = document.getElementById('reset-timer');
            const timer = setInterval(() => {
                ms -= 1000;
                if(ms <= 0) { clearInterval(timer); updateUI(); return; }
                const h = Math.floor(ms/3600000).toString().padStart(2,'0');
                const m = Math.floor((ms%3600000)/60000).toString().padStart(2,'0');
                const s = Math.floor((ms%60000)/1000).toString().padStart(2,'0');
                el.innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        window.loginGoogle = () => signInWithPopup(auth, provider);
        window.loginEmail = () => signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value);
        window.logout = () => { signOut(auth); localStorage.clear(); location.reload(); };
        window.toggleMenu = () => document.getElementById('sidebar').classList.toggle('open');
        window.openStore = () => document.getElementById('store-modal').classList.remove('hidden');
        window.closeStore = () => document.getElementById('store-modal').classList.add('hidden');
        window.openKeyModal = () => document.getElementById('key-modal').classList.remove('hidden');
        window.closeKeyModal = () => document.getElementById('key-modal').classList.add('hidden');

        window.saveKey = async () => {
            const val = document.getElementById('api-input').value.trim();
            if(!val) return;
            geminiKey = val; localStorage.setItem('da_gemini_v55', val);
            if(auth.currentUser) await updateDoc(doc(db, "users", auth.currentUser.uid), { apiKey: val });
            showToast("Chave Salva!");
            closeKeyModal();
        }

        window.newConversation = () => {
            if(userData.plan === 'free' && sessions.length >= 2) { showToast("Limite Free: 2 Conversas"); return; }
            const id = Date.now();
            sessions.unshift({ id, title: "Protocolo Novo", messages: [{ role: 'ai', text: 'Rafael, terminal v55 operacional.' }] });
            localStorage.setItem('da_v55_sessions', JSON.stringify(sessions));
            refreshList(); loadSession(id);
        };

        window.loadSession = (id) => {
            currentId = id;
            const s = sessions.find(x => x.id === id);
            document.getElementById('active-title').innerText = s.title;
            const win = document.getElementById('chat-window');
            win.innerHTML = '';
            s.messages.forEach(m => renderBubble(m.role, m.text));
            refreshList();
        }

        function refreshList() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            sessions.forEach((s, idx) => {
                const isLocked = userData.plan === 'free' && idx >= 2;
                const item = document.createElement('div');
                item.className = `chat-item ${s.id === currentId ? 'active' : ''} ${isLocked ? 'locked' : ''}`;
                item.innerHTML = `<span><i class="fa-solid fa-terminal mr-2 opacity-50"></i>${s.title}</span> ${isLocked ? '<i class="fa-solid fa-lock"></i>' : ''}`;
                if(!isLocked) item.onclick = () => loadSession(s.id);
                list.appendChild(item);
            });
        }

        window.send = async () => {
            const pin = document.getElementById('prompt');
            const val = pin.value.trim();
            if(!val || !geminiKey) return;
            renderBubble('user', val); pin.value = '';
            await updateDoc(doc(db, "users", auth.currentUser.uid), { used: (userData.used || 0) + 1 });
            const s = sessions.find(x => x.id === currentId);
            if(s.title === "Protocolo Novo") { s.title = val.substring(0, 15); refreshList(); }
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: val }] }] })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro.";
                renderBubble('ai', text);
                s.messages.push({ role: 'user', text: val }, { role: 'ai', text: text });
                localStorage.setItem('da_v55_sessions', JSON.stringify(sessions));
            } catch (e) { renderBubble('ai', "ERRO."); }
        }

        function renderBubble(role, text) {
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `bubble ${role === 'ai' ? 'bubble-ai' : 'bubble-user'}`;
            div.innerHTML = `<span class="text-[7px] font-black uppercase opacity-20 block mb-1">${role === 'ai' ? 'Angel' : 'Rafael'}</span>${text}`;
            win.appendChild(div); win.scrollTop = win.scrollHeight;
        }
    </script>
</body>
</html>

